{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}TODO{% endblock %}</title>
  <link rel="manifest" href="{% static 'manifest.webmanifest' %}">
  <meta name="theme-color" content="#0ea5e9">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://unpkg.com/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://unpkg.com/htmx.org@1.9.6"></script>
  
  <script>
    // Aggressive cache clearing for solo-todo to todo migration
    (function() {
      // Clear old service worker caches on page load
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
          for(let registration of registrations) {
            registration.unregister();
          }
        });
        
        // Clear old caches
        if ('caches' in window) {
          caches.keys().then(function(cacheNames) {
            let hasOldCache = false;
            return Promise.all(
              cacheNames.map(function(cacheName) {
                if (cacheName.includes('solo-todo') || cacheName === 'todo-v1') {
                  console.log('Clearing old cache:', cacheName);
                  hasOldCache = true;
                  return caches.delete(cacheName);
                }
              })
            ).then(() => {
              // If we found old caches, reload the page
              if (hasOldCache) {
                console.log('Old caches cleared, reloading page...');
                setTimeout(() => {
                  window.location.reload(true);
                }, 1000);
              }
            });
          });
        }
      }
      
      // Also clear localStorage if it contains old data
      if (localStorage.getItem('solo-todo')) {
        localStorage.removeItem('solo-todo');
        console.log('Cleared old localStorage data');
      }
    })();
  </script>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen text-slate-900">
  <header class="bg-white/80 backdrop-blur-sm border-b border-slate-200 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-4">
      <a href="/" class="text-xl font-bold text-sky-600 flex items-center gap-2">
        <i class="fas fa-tasks"></i>
        TODO
      </a>
      <nav class="flex items-center gap-1 text-sm">
        <a class="px-3 py-2 rounded-lg hover:bg-sky-50 hover:text-sky-700 transition-colors flex items-center gap-2" href="/">
          <i class="fas fa-home"></i> Dashboard
        </a>
        <a class="px-3 py-2 rounded-lg hover:bg-sky-50 hover:text-sky-700 transition-colors flex items-center gap-2" href="{% url 'all_tasks' %}">
          <i class="fas fa-list"></i> All Tasks
        </a>
        <a class="px-3 py-2 rounded-lg hover:bg-sky-50 hover:text-sky-700 transition-colors flex items-center gap-2" href="{% url 'calendar' %}">
          <i class="fas fa-calendar"></i> Calendar
        </a>
        <a class="px-3 py-2 rounded-lg hover:bg-sky-50 hover:text-sky-700 transition-colors flex items-center gap-2" href="/projects/">
          <i class="fas fa-folder"></i> Projects
        </a>
        <a class="px-3 py-2 rounded-lg hover:bg-sky-50 hover:text-sky-700 transition-colors flex items-center gap-2" href="{% url 'sketch_list' %}">
          <i class="fas fa-paint-brush"></i> Sketches
        </a>
      </nav>
      <div class="ml-auto flex items-center gap-3">
        {% if user.is_authenticated %}
        <button onclick="openQuickAdd()" class="bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
          <i class="fas fa-plus"></i> Quick Add
        </button>
        <div class="flex items-center gap-2">
          <span class="text-sm text-slate-600">{{ user.username }}</span>
          <form method="post" action="{% url 'logout' %}" class="inline">
            {% csrf_token %}
            <button type="submit" class="text-sm text-slate-600 hover:text-slate-900 px-2 py-1 rounded hover:bg-slate-100 transition-colors">
              <i class="fas fa-sign-out-alt"></i>
            </button>
          </form>
        </div>
        {% else %}
        <a href="{% url 'login' %}" class="text-sm text-sky-600 hover:text-sky-700 px-3 py-2 rounded-lg hover:bg-sky-50 transition-colors">
          <i class="fas fa-sign-in-alt"></i> Login
        </a>
        <a href="{% url 'register' %}" class="text-sm bg-sky-600 hover:bg-sky-700 text-white px-3 py-2 rounded-lg transition-colors">
          <i class="fas fa-user-plus"></i> Register
        </a>
        {% endif %}
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    {% block content %}{% endblock %}
  </main>

  <!-- Quick Add Modal -->
  <div id="quickAddModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold">Quick Add Task</h2>
        <button onclick="closeQuickAdd()" class="text-slate-400 hover:text-slate-600">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <form method="post" action="{% url 'quick_add' %}" class="space-y-4">
        {% csrf_token %}
        
        <!-- Task Title -->
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">
            <i class="fas fa-heading mr-2"></i>Task Title *
          </label>
          <input name="title" id="quickAddTitle" class="w-full border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-sky-500 focus:border-transparent" 
                 placeholder="Enter task title" required />
        </div>

        <!-- Project -->
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">
            <i class="fas fa-folder mr-2"></i>Project
          </label>
          <select name="project" id="quickAddProject" class="w-full border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-sky-500 focus:border-transparent">
            <option value="">No Project</option>
            {% for project in projects %}
              <option value="{{ project.id }}">{{ project.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Priority -->
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">
            <i class="fas fa-flag mr-2"></i>Priority
          </label>
          <select name="priority" id="quickAddPriority" class="w-full border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-sky-500 focus:border-transparent">
            <option value="1">P1 - Critical</option>
            <option value="2">P2 - High</option>
            <option value="3" selected>P3 - Medium</option>
            <option value="4">P4 - Low</option>
            <option value="5">P5 - Minimal</option>
          </select>
        </div>

        <!-- Due Date -->
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">
            <i class="fas fa-calendar mr-2"></i>Due Date
          </label>
          <div class="flex gap-2">
            <input type="datetime-local" name="due_at" id="quickAddDueDate" class="flex-1 border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-sky-500 focus:border-transparent" />
            <button type="button" onclick="setDefaultTime()" class="px-3 py-3 bg-slate-100 hover:bg-slate-200 border border-slate-300 rounded-lg transition-colors text-sm">
              <i class="fas fa-clock"></i>
            </button>
          </div>
          <p class="text-xs text-slate-500 mt-1">Default time: 23:59 â€¢ Click clock to reset</p>
        </div>

        <!-- Estimate -->
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">
            <i class="fas fa-clock mr-2"></i>Estimate (minutes)
          </label>
          <input type="number" name="estimate_minutes" id="quickAddEstimate" class="w-full border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-sky-500 focus:border-transparent" 
                 placeholder="30" min="1" />
        </div>

        <!-- Tags -->
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">
            <i class="fas fa-tags mr-2"></i>Tags
          </label>
          <input name="tags" id="quickAddTags" class="w-full border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-sky-500 focus:border-transparent" 
                 placeholder="bug, feature, urgent (comma separated)" />
        </div>

        <!-- Description -->
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">
            <i class="fas fa-align-left mr-2"></i>Description
          </label>
          <textarea name="description" id="quickAddDescription" rows="3" class="w-full border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-sky-500 focus:border-transparent" 
                    placeholder="Optional task description"></textarea>
        </div>

        <div class="flex gap-2 pt-4">
          <button type="submit" class="bg-sky-600 hover:bg-sky-700 text-white px-6 py-2 rounded-lg transition-colors flex items-center gap-2">
            <i class="fas fa-plus mr-2"></i>Add Task
          </button>
          <button type="button" onclick="closeQuickAdd()" class="px-6 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="{% static 'js/app.js' %}"></script>
  
  <!-- Global Priority Badge Styles -->
  <style>
    /* Priority badge colors - consistent across all templates */
    .priority-badge.priority-1 { 
      background-color: #fee2e2; 
      color: #dc2626; 
      border-color: #fecaca; 
    }
    .priority-badge.priority-2 { 
      background-color: #fef3c7; 
      color: #d97706; 
      border-color: #fed7aa; 
    }
    .priority-badge.priority-3 { 
      background-color: #dbeafe; 
      color: #2563eb; 
      border-color: #bfdbfe; 
    }
    .priority-badge.priority-4 { 
      background-color: #dcfce7; 
      color: #16a34a; 
      border-color: #bbf7d0; 
    }
    .priority-badge.priority-5 { 
      background-color: #f3f4f6; 
      color: #6b7280; 
      border-color: #e5e7eb; 
    }
    
    /* Status badge colors */
    .status-badge.status-todo { background-color: #f1f5f9; color: #475569; }
    .status-badge.status-in_progress { background-color: #dbeafe; color: #2563eb; }
    .status-badge.status-blocked { background-color: #fee2e2; color: #dc2626; }
    .status-badge.status-done { background-color: #dcfce7; color: #16a34a; }
  </style>
  
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('{% static 'sw.js' %}');
      });
    }

    function openQuickAdd() {
      document.getElementById('quickAddModal').classList.remove('hidden');
      document.getElementById('quickAddTitle').focus();
    }

    function closeQuickAdd() {
      document.getElementById('quickAddModal').classList.add('hidden');
    }

    // Set default time to 23:59 when date is selected
    document.getElementById('quickAddDueDate').addEventListener('change', function() {
      const dateInput = this;
      const selectedDate = dateInput.value;
      
      if (selectedDate && !selectedDate.includes('T')) {
        // If only date is selected, add time 23:59
        const dateWithTime = selectedDate + 'T23:59';
        dateInput.value = dateWithTime;
      }
    });

    // Function to set default time (23:59) for selected date
    function setDefaultTime() {
      const dateInput = document.getElementById('quickAddDueDate');
      const selectedDate = dateInput.value;
      
      if (selectedDate) {
        // Extract date part and add 23:59 time
        const datePart = selectedDate.split('T')[0];
        const dateWithTime = datePart + 'T23:59';
        dateInput.value = dateWithTime;
      } else {
        // If no date selected, set today's date with 23:59
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const dateWithTime = `${year}-${month}-${day}T23:59`;
        dateInput.value = dateWithTime;
      }
    }

    // Close modal on outside click
    document.getElementById('quickAddModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeQuickAdd();
      }
    });

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeQuickAdd();
      }
    });
  </script>
</body>
</html> 